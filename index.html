<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Magazine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ── 타이포그래피 & 레이아웃 ─────────────────────────── */
    body{
      font-family:"Hiragino Kaku Gothic ProN",sans-serif;
      background: linear-gradient(180deg,#ffffff 70%,rgba(200,200,200,.15) 100%);
      padding:40px;
      text-align:center;
    }
    .magazine-title{
      font-family:'Georgia',serif;
      font-size:2.5rem;
      color:#000;
      letter-spacing:2px;
      margin-bottom:1em;
      text-shadow:2px 2px 5px rgba(0,0,0,.2);
    }
    .container{display:flex;gap:30px;}

    /* ── 사이드바 ───────────────────────────────────────── */
    .sidebar{
      height:660px;overflow:hidden;width:200px;padding-top:20px;font-size:.95rem;
    }
    .sidebar-title{
      font-family:'Georgia','Hiragino Kaku Gothic ProN',serif;
      font-size:15px;font-weight:500;color:#222;letter-spacing:.08em;text-transform:uppercase;
      padding-left:10px;margin-bottom:12px;line-height:1.2;text-shadow:2px 2px 5px rgba(0,0,0,.2);
      border-bottom:1px solid #eee;padding-bottom:4px;
    }
    .keywordScroller{height:100%;overflow:hidden;position:relative;}
    .keywordList{display:flex;flex-direction:column;gap:10px;will-change:transform;}
    .sidebar:hover .keywordList{animation-play-state:paused;}
    @keyframes slide-vertical{from{transform:translateY(0)}to{transform:translateY(-50%)}}
    .keyword {
      font-size: .97em;
      background: #f5f5f5;        /* 밝은 회색 배경 */
      color: #222;                /* 짙은 회색 글씨 */
      text-shadow:0 2px 4px rgba(0,0,0,.25);
      border-radius: 14px;
      padding: 5px 13px;
      font-weight: 500;
      letter-spacing: .02em;
      border: 1px solid #ccc;     /* 연한 회색 테두리 */
      box-shadow: 0 1px 2px #0002;
      transition: .2s;
      white-space: normal;
      word-break: break-word;
      max-width: 100%;
      cursor: pointer;
    }
    .keyword:hover {
      background: #333;           /* 진한 회색/검정 배경 */
      color: #fff;                /* 흰색 글씨 */
    }

    .keyword.active {
      background: #000;           /* 완전 검정 배경 */
      color: #fff;
      font-weight: bold;
    }


    /* ── 메인 영역 ──────────────────────────────────────── */
    .main-content{flex:1;display:flex;flex-direction:row;align-items:flex-start;gap:6px;}

    .gallery {
      gap: 20px;
      column-count: 3; /* 원하는 열 개수 */
    }

    .card {
      display: inline-block;
      justify-content: center;
      width: 100%;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .card a{display:block;text-decoration:none;color:inherit}

    .card img {
      max-width: 100%;      /* 가로는 카드 폭에 맞춤 */
      max-height: 100%;     /* 세로는 카드 높이에 맞춤 */
      width: auto;          /* 비율 유지 */
      height: auto;         /* 비율 유지 */
      object-fit: contain;  /* 잘림 없이 축소 */
      display: block;
      border-style: solid; 
      border-width: 2px;
      border-radius: 1.375em; 
      box-shadow: 5px 5px 6px var(--tw-shadow-color,#000000b3);
    }

    .card:hover{transform:translateY(-12px) scale(1.03);z-index:2}

    .card-license {
      font-size: 0.75rem;
      color: #555;
      padding: 6px 10px;
      border-top: 1px solid #eee;
      background: #fafafa;
      text-align: center;
      opacity: 0;        
      transition: background 0.2s, color 0.2s;
      pointer-events: none;      /* 숨김 상태에서 클릭 불가 */
    }

    .card-license a {
      color: inherit;
      text-decoration: none;
    }

    .card:hover .card-license {
      background: #222;
      opacity: 1;
      color: #fff;
    }
    .card:hover .card-license a {
      color: #fff;
      text-decoration: underline;
    }

    .caption{font-size:1.05rem;color:#333;padding:10px 15px;text-shadow:0 2px 4px rgba(0,0,0,.25);line-height:1.6}
    .card-keywords{
      font-size: 0.8rem; 
      display:flex;flex-wrap:wrap;gap:8px 10px;margin-top:10px;margin-bottom:6px;justify-content:center;
      max-height:130px;overflow-y:auto;overflow-x:hidden;
    }
    .card-keywords::-webkit-scrollbar{height:0;width:6px}
    .card-keywords::-webkit-scrollbar-thumb{background:#dde3ed;border-radius:8px}

    .card-body {
      padding: 10px;
      text-align: center;
    }

    .card-icon {
      font-size: 1.5rem;
      margin: 8px 0;
    }

    .card-title {
      font-family:'Georgia',serif;
      font-size: 1.3rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-shadow: 0 2px 4px var(--tw-text-shadow-color,#00000040);
    }

    .card-desc {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* 2줄 제한 */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }


    /* ── 메뉴/검색 ──────────────────────────────────────── */
    .menu{flex:0 0 10%;position:relative;display:flex;flex-direction:column;gap:2px;align-items:flex-end}
    .menu-block{position:relative;display:flex;align-items:center;gap:10px;border-radius:8px;padding:8px 14px;font-size:1rem;font-weight:bold;font-family:"Georgia","Hiragino Kaku Gothic ProN",serif}
    .menu-link{color:#000;line-height:1;font-size:1.8rem;text-align:center}
    .refresh-button{font:inherit;line-height:1;font-size:1.8rem;text-align:center;background:none;cursor:pointer;border:none;padding:0;outline:none}
    .menu-label{
      position:absolute;top:50%;right:120%;transform:translateY(-50%);background:#222;color:#fff;font-size:.8rem;
      padding:4px 8px;border-radius:6px;white-space:nowrap;opacity:0;transition:opacity .2s ease;pointer-events:none;z-index:10
    }
    .menu-block:hover .menu-label{opacity:1}
    .search-box{display:flex;align-items:center;transition:all .3s ease;border:1px solid transparent}
    .search-icon{font-size:1.8rem;cursor:pointer;line-height:1}
    .search-box input{
      padding:6px 10px;font-size:1rem;border-radius:6px;background:#fff;color:#000;width:0;opacity:0;pointer-events:none;
      transition:width .3s ease,opacity .2s ease;font-family:'Georgia',serif
    }
    .search-box.active{border:1px solid #000}
    .search-box.active input{width:200px;opacity:1;pointer-events:all}

    .copyright-footer {
      text-align: center;
      font-size: 12px;
      color: #666;
      padding: 10px 0;
      background-color: #f8f8f8;
      border-top: 1px solid #ddd;
    }

    .copyright-footer a {
      color: #666;
      text-decoration: none;
    }

    .copyright-footer a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div class="magazine-title">MAGAZINE</div>

  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-title">Activate a Topic 🖲️</div>
      <div class="keywordScroller"><div class="keywordList" id="keywordList"></div></div>
    </aside>

    <div class="main-content">
      <div class="gallery" id="gallery"></div>

      <div class="menu">
        <div class="menu-block search-box" id="searchBox">
          <input type="text" id="searchInput" placeholder="Search by keyword…">
          <span class="search-icon" id="searchIcon">🔍</span>
        </div>

        <div class="menu-block">
          <a href="notes.html" target="_blank" class="menu-link" aria-label="Notes"><span class="menu-label">Notes</span>📚</a>
        </div>

        <div class="menu-block">
          <button type="button" class="refresh-button" id="refreshBtn" aria-label="Refresh">
            <span class="menu-label">Refresh</span>🔄
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="copyright-footer">
    Photos provided by 
    <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">
      Unsplash
    </a>
    &nbsp;— Free to use under the 
    <a href="https://unsplash.com/license" target="_blank" rel="noopener noreferrer">
      Unsplash License
    </a>.
  </footer>


  <!-- 이미지 메타데이터 (imageData 변수) -->
  <script src="metadata.js"></script>

  <script>
    /* ============ 간단 유틸 ============ */
    const gallery = document.getElementById('gallery');
    const keywordListEl = document.getElementById('keywordList');
    const searchBox  = document.getElementById('searchBox');
    const searchInput= document.getElementById('searchInput');
    const searchIcon = document.getElementById('searchIcon');

    // 인덱스 부여
    const data = imageData.map((item, idx) => ({ ...item, index: idx }));

    /* ============ 갤러리 렌더 ============ */
    function renderGallery(list) {
      gallery.innerHTML = '';

      list.slice().reverse().forEach((data, i) => {
        const card = document.createElement('div');
        card.className = 'card';

        // 상세 페이지 링크
        const idx = (typeof data.index === 'number') ? data.index : i;
        const link = document.createElement('a');
        link.href = `pages/${idx + 1}-1.html`;
        link.setAttribute('aria-label', data.title || data.caption || 'article');
        link.style.display = 'block';

        // 썸네일
        const img = document.createElement('img');
        img.src = data.filename;
        img.alt = data.title || data.caption || 'thumbnail';
        img.loading = 'lazy';
        img.decoding = 'async';

        link.appendChild(img);
        card.appendChild(link);

        // 본문(아이콘 + 제목 + 설명 + 날짜)
        const body = document.createElement('div');
        body.className = 'caption'; // 기존 캡션 스타일 재사용

        const icon = document.createElement('div');
        icon.className = 'card-icon';
        icon.textContent = data.icon || '📝';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = data.title || '';

        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.textContent = data.caption || '';

        const keywordEl = document.createElement('div');
        keywordEl.className = 'card-keywords';

        // 키워드를 하나의 문자열로 결합
        if (Array.isArray(data.keywords) && data.keywords.length > 0) {
          const keywordsText = data.keywords.map(k => '#' + k.toLowerCase()).join(' ');
          keywordEl.textContent = keywordsText;

          // 데이터 속성으로도 저장
          keywordEl.setAttribute('data-keywords', escapeCSSAttr(keywordsText));
        }

        const dateSmall = document.createElement('small');
        dateSmall.className = 'card-date';
        dateSmall.textContent = data.date || '';

        body.append(title, keywordEl, dateSmall);
        card.append(body);

        gallery.append(card);
      });
    }
    /* ============ 키워드 영역 ============ */
    const allKeywords = [...new Set(data.flatMap(i => (i.keywords || []).map(k => String(k).toLowerCase())) )];
    function renderKeywords(){
      keywordListEl.innerHTML = '';
      // 무한 스크롤 효과용으로 2회 반복
      for(let r=0;r<2;r++){
        allKeywords.forEach(k=>{
          const btn = document.createElement('div');
          btn.className = 'keyword';
          btn.textContent = '#' + k;
          btn.addEventListener('click',()=>{
            filterByKeyword(k);
          });
          keywordListEl.appendChild(btn);
        });
      }
      // 애니메이션 시작
      const singleHeight = keywordListEl.scrollHeight / 2;
      let pos=0, speed=0.5, auto=true;
      function tick(){
        if(auto){
          pos+=speed;
          if(pos>=singleHeight) pos=0;
          keywordListEl.style.transform = `translateY(-${pos}px)`;
        }
        requestAnimationFrame(tick);
      }
      keywordListEl.parentElement.addEventListener('mouseenter',()=>auto=false);
      keywordListEl.parentElement.addEventListener('mouseleave',()=>auto=true);
      tick();
    }

      function escapeCSSAttr(str) {
        return str
          .replace(/\\/g, "\\\\")      // must go first!
          .replace(/"/g, "\\0022 ")    // "
          .replace(/'/g, "\\0027 ")    // '
          .replace(/</g, "")           // strip <
          .replace(/>/g, "")           // strip >
          .replace(/\n/g, " ")         // newlines to space
          .replace(/&/g, "&");         // optional: entity pass-through
      }

    function filterByKeyword(k){
      const filtered = data.filter(i => (i.keywords || []).map(x=>String(x).toLowerCase()).includes(k));
      renderGallery(filtered);
      document.querySelectorAll('.keyword').forEach(el=>{
        const label = el.textContent.replace(/^#/,'').toLowerCase();
        el.classList.toggle('active', label===k);
      });
    }

    /* ============ 검색 ============ */
    function toggleSearch(){
      searchBox.classList.toggle('active');
      if(searchBox.classList.contains('active')) searchInput.focus();
      else{
        searchInput.value='';
        renderGallery(data);
      }
    }
    searchIcon.addEventListener('click',toggleSearch);
    searchInput.addEventListener('input',()=>{
      const q = searchInput.value.toLowerCase();
      const list = data.filter(item =>
        Array.isArray(item.keywords) && item.keywords.some(k => String(k).toLowerCase().includes(q))
      );
      renderGallery(list);
    });
    document.addEventListener('click', e=>{
      if(searchBox.classList.contains('active') && !searchBox.contains(e.target)){
        searchBox.classList.remove('active');
        searchInput.value='';
        renderGallery(data);
      }
    });

    /* ============ 새로고침 버튼 ============ */
    document.getElementById('refreshBtn').addEventListener('click',()=>{
      document.querySelectorAll('.keyword').forEach(el=>el.classList.remove('active'));
      renderGallery(data);
    });

    /* ============ 과거 해시 링크 호환 (#/N → viewer.html?i=N) ============ */
    function legacyHashRedirect(){
      const m = location.hash.match(/^#\/(\d+)$/);
      if(m){
        const n = parseInt(m[1],10);
        if(!Number.isNaN(n) && n>0) {
          location.replace(`viewer.html?i=${n}`);
        }
      }
    }

    function resizeAllMasonryItems() {
      document.querySelectorAll('.card').forEach(item => {
        const grid = document.querySelector('.gallery');
        const rowHeight = parseInt(getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
        const rowGap = parseInt(getComputedStyle(grid).getPropertyValue('grid-gap'));
        const contentHeight = item.querySelector('img').getBoundingClientRect().height
          + item.querySelector('.caption').getBoundingClientRect().height;
        const rowSpan = Math.ceil((contentHeight + rowGap) / (rowHeight + rowGap));
        item.style.gridRowEnd = `span ${rowSpan}`;
      });
    }

    window.addEventListener('load', resizeAllMasonryItems);
    window.addEventListener('resize', resizeAllMasonryItems);


    /* ============ 초기 구동 ============ */
    window.addEventListener('DOMContentLoaded',()=>{
      renderKeywords();
      renderGallery(data);
      legacyHashRedirect();
    });


  </script>
</body>
</html>
